<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="style.css">
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
  </head>
  <body>
    <script>

      $(document).ready(function(){
        var $body = $('body');
        $body.html('');

        // flag for user filtering
        var userFilter = '';
        // button for reshowing all available tweets
        $body.append('<button id="show-all-tweets"><p>Show all tweets</p></button>')

        // container for responsive layout
        const $container = $('<div id="container"></div>');
        $body.append($container);

        function addUserNameClickHandler(elem) {
          // click handler on username, to see only that user's tweets
          // Almost positive there's a better way to get the <a> element in this particular card!
          $(elem).children('.tweet-card-footer').children().children().on('click', function(e) {
            e.preventDefault();
            let allTweets = $('div.tweet-card').get();
            allTweets.forEach((tweetCard) => {
              $(tweetCard).removeClass('opaque');
            })
            userFilter = e.target.textContent.slice(1);

            let tweetsToHide = allTweets.filter((tweetCard) => {
              let user = tweetCard.querySelector('a').textContent;
              return user !== e.target.textContent;
            });

            tweetsToHide.forEach((tweetCard) => {
              let user = tweetCard.querySelector('a').textContent;
              $(tweetCard).addClass('opaque');
            });
          });
        }

        // click handler only sometimes registering clicks ... DOM event listener breakpoint from dev tools only sometimes firing

        // click handler for show all tweets button
        $('#show-all-tweets').on('click', function() {
          console.log("you clidked it!")
          userFilter = '';
          $('.tweet-card').get().forEach((tweetCard) => {
            $(tweetCard).removeClass('opaque');
          })
        })

        // periodically check if last index in streams.home is the the most recent one we have
          // if not
            // add new tweets from streams.home
        var index = streams.home.length - 1;
        var lastIndex = -1;

        function sourceTweets() {
          index = streams.home.length - 1;
          while(index > lastIndex){
            var tweet = streams.home[index];
            var $tweet = $(`<div class="tweet-card"></div>`);
            if (userFilter && userFilter !== tweet.user) {
              $($tweet).addClass('opaque');
            }

            var $tweetCardFooter = $('<div class="tweet-card-footer"></div>');
            $tweet.append($tweetCardFooter);
            $tweetCardFooter.append(`<p class="user"><a href="">@${tweet.user}</a></p><p class="timestamp">${tweet.created_at}</p>`);
            $tweet.prepend(`<p class="tweet">${tweet.message}</p>`);
            $tweet.appendTo($container);
            index -= 1;

            addUserNameClickHandler($tweet);
          }
        }

        sourceTweets();
        setInterval(function() {
          sourceTweets();
        }, 10000);
      });

    </script>
  </body>
</html>
