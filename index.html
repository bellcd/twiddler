<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css?family=Muli:200,400,400i,700&display=swap" rel="stylesheet">
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
    <script type="text/javascript" src="moment.min.js">

    </script>
  </head>
  <body>
    <script>

      // global variables for writing tweets
      var visitor, message;

      $(document).ready(function(){
        var $body = $('body');
        $body.html('');

        const $title = $('<h1>Twiddler</h1>');
        $body.append($title);

        // fix all of the other places that use $(<...>) !!!???
        // form for visitor to write a tweet
        const $writeTweetContainer = $('<form id="write-tweet-container"><div><input id="visitor" type="text" placeholder="your name"></input></div><div><input id="message" type="text" placeholder="tweet..."></input></div><div><button id="write-tweet-btn">write tweet</button></div></form>')[0];
        const $visitor = $('#visitor');
        const $message = $('#message');
        const $writeTweetButton = $('#write-tweet-btn');
        $body.append($writeTweetContainer);


        // flag for user filtering
        var userFilter = '';
        // button for reshowing all available tweets
        $body.append('<button id="show-all-tweets"><p>Show all tweets</p></button>')

        // container for responsive layout
        const $container = $('<div id="container"></div>');
        $body.append($container);

        // click handler on writing a tweet
        $('#write-tweet').on('click', function() {
          // debugger;
          console.log($visitor);
          visitor = $visitor.value;
          console.log(visitor);
          message = $message.value;

          writeTweet(message);
          sourceTweets();
        })


        function addUserNameClickHandler(elem) {
          // click handler on username, to see only that user's tweets
          // Almost positive there's a better way to get the <a> element in this particular card!
          $(elem).children('.tweet-card-footer').children().children().on('click', function(e) {
            e.preventDefault();
            let allTweets = $('div.tweet-card').get();
            allTweets.forEach((tweetCard) => {
              $(tweetCard).removeClass('opaque');
            })
            userFilter = e.target.textContent.slice(1);

            let tweetsToHide = allTweets.filter((tweetCard) => {
              let user = tweetCard.querySelector('a').textContent;
              return user !== e.target.textContent;
            });

            tweetsToHide.forEach((tweetCard) => {
              let user = tweetCard.querySelector('a').textContent;
              $(tweetCard).addClass('opaque');
            });
          });
        }

        // click handler only sometimes registering clicks ... DOM event listener breakpoint from dev tools only sometimes firing

        // click handler for show all tweets button
        $('#show-all-tweets').on('click', function() {
          console.log("you clidked it!")
          userFilter = '';
          $('.tweet-card').get().forEach((tweetCard) => {
            $(tweetCard).removeClass('opaque');
          })
        })

        // periodically check if last index in streams.home is the the most recent one we have
          // if not
            // add new tweets from streams.home
        var index = streams.home.length - 1;
        var lastIndex = -1;

        function sourceTweets() {
          index = streams.home.length - 1;
          while(index > lastIndex){
            var tweet = streams.home[index];
            var $tweet = $(`<div class="tweet-card"></div>`);
            if (userFilter && userFilter !== tweet.user) {
              $($tweet).addClass('opaque');
            }

            moment.updateLocale('en', {
              relativeTime: {
                past: '%s ago',
                // mm: '%d minutes'
                ss: '%d seconds'
              }
            });

            var $tweetCardFooter = $('<div class="tweet-card-footer"></div>');
            $tweet.append($tweetCardFooter);

            $tweetCardFooter.append(`<p class="user"><a href="">@${tweet.user}</a></p><p class="timestamp">${moment(tweet.created_at).fromNow()}</p>`);
            $tweet.prepend(`<p class="tweet">${tweet.message}</p>`);
            $tweet.appendTo($container);
            index -= 1;

            addUserNameClickHandler($tweet);
          }
        }

        sourceTweets();
        setInterval(function() {
          sourceTweets();
        }, 10000);
      });

    </script>
  </body>
</html>
